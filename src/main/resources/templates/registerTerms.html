<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ANKIM 이용 약관 동의</title>
    <link rel="stylesheet" href="/css/styles.css"> <!-- Add your styles here -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function checkRequiredTerms() {
            // 필수 약관 체크박스 중에서 체크되지 않은 항목이 있는지 확인
            const allRequiredChecked = [...document.querySelectorAll('input[name="termsAgreements"][data-required="true"]')]
                .every(input => input.checked);

            // 모든 필수 항목이 체크되면 버튼 활성화, 아니면 비활성화
            document.getElementById('nextButton').disabled = !allRequiredChecked;
        }

        // Function to open the modal and display term content
        function openModal(content) {
            document.getElementById("modalContent").innerText = content;
            document.getElementById("termsModal").style.display = "block";
        }

        // Function to close the modal
        function closeModal() {
            document.getElementById("termsModal").style.display = "none";
        }

        function submitTerms() {
            const termsAgreements = [...document.querySelectorAll('input[name="termsAgreements"]')].map(input => ({
                no: input.getAttribute("data-no"),
                name: input.getAttribute("data-name"),
                level: input.getAttribute("data-level"),
                termsYn: input.getAttribute("data-termsyn"),
                agreeYn: input.checked ? "Y" : "N"
            }));

            fetch("/api/member/terms-next", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(termsAgreements)
            })
                .then(response => {
                    if (response.ok) {
                        window.location.href = "/api/mail/emailVerification";
                    } else {
                        alert("약관 동의 전송 중 오류가 발생했습니다.");
                    }
                })
                .catch(error => console.error("Fetch error:", error));
        }


        $(document).ready(function () {
            $('#selectAll').on('change', function() {
                $('input[name="termsAgreements"]').prop('checked', this.checked);
            });
        });
    </script>
    <style>
        /* Style the modal */
        #termsModal {
            display: none;
            position: fixed;
            z-index: 1;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }
        #modalContent {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            width: 80%;
        }
    </style>
</head>
<body>

<h1>ANKIM 이용 약관에 동의해 주세요</h1>

<form id="termsForm">
    <div>
        <label>
            <input type="checkbox" id="selectAll">
            전체 동의하기 (선택 정보를 포함합니다.)
        </label>
        <p>선택 사항에 대한 동의를 거부하는 경우에도 서비스는 이용이 가능합니다.</p>
    </div>
    <hr/>

    <!-- Terms List -->
    <div th:each="term : ${termsList}">
        <div>
            <label>
                <input type="checkbox" name="termsAgreements"
                       th:data-no="${term.no}"
                       th:data-name="${term.name}"
                       th:data-level="${term.level}"
                       th:data-termsyn="${term.termsYn}"
                       onchange="checkRequiredTerms()"> <!-- 체크박스 변경 시 확인 -->
                <span th:text="${term.name}">약관 제목</span>
            </label>
            <a href="javascript:void(0)" onclick="openModal([[${term.contents}]])" th:if="${term.contents}">
                자세히
            </a>
        </div>
        <hr/>
    </div>

    <!-- Submit Button -->
    <button type="button" onclick="submitTerms()">다음</button>
</form>

<!-- Modal for detailed terms -->
<div id="termsModal">
    <div id="modalContent">
        <span onclick="closeModal()" style="cursor:pointer;">&times;</span>
        <p id="termContent"></p>
    </div>
</div>

</body>
</html>