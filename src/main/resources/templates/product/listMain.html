<div class="list-main" th:fragment="listMain">
    <!-- ì¤‘ë¶„ë¥˜ ì¹´í…Œê³ ë¦¬ ì´ë¦„ê³¼ ê²€ìƒ‰ -->
    <div class="category-header">
        <h2 class="subcategory-title" th:text="${subCategoryTitle}">ì¤‘ë¶„ë¥˜ ì¹´í…Œê³ ë¦¬ ì´ë¦„</h2>
        <div class="search-bar">
            <input type="text" id="search-input" />
            <button type="button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-search">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
        </div>
    </div>
    <!-- ì¹´í…Œê³ ë¦¬ì™€ ì •ë ¬ -->
    <div class="category-sort-section">
        <!-- ì¹´í…Œê³ ë¦¬ ë©”ë‰´ (í•˜ìœ„ ì¹´í…Œê³ ë¦¬ê°€ ì¡´ì¬í•  ê²½ìš°ì—ë§Œ ì¶œë ¥) -->
        <div class="category-menu" th:classappend="${#lists.isEmpty(subCategories)} ? 'hidden' : ''">
            <ul>
                <!-- ì „ì²´ ì¹´í…Œê³ ë¦¬ -->
                <li th:classappend="${category == null} ? 'active' : ''">
                    <a href="#" class="category-link" data-category="">ì „ì²´</a>
                </li>

                <!-- í•˜ìœ„ ì¹´í…Œê³ ë¦¬ ëª©ë¡ -->
                <li th:each="subCategory : ${subCategories}"
                    th:classappend="${category != null and category == subCategory.categoryNo} ? 'active' : ''">
                    <a href="#" class="category-link" th:attr="data-category=${subCategory.categoryNo}" th:text="${subCategory.name}"></a>
                </li>
            </ul>
        </div>

        <!-- ì •ë ¬ ì„ íƒ -->
        <div class="custom-select">
            <div class="selected-option" tabindex="0">
                ì¸ê¸°ìˆœ
                <span class="dropdown-arrow">â–¼</span>
            </div>
            <ul class="dropdown-options">
                <li data-value="POPULAR">ì¸ê¸°ìˆœ</li>
                <li data-value="LATEST">ìµœì‹ ìˆœ</li>
                <li data-value="LOW_PRICE">ë‚®ì€ ê°€ê²©ìˆœ</li>
                <li data-value="HIGH_PRICE">ë†’ì€ ê°€ê²©ìˆœ</li>
                <li data-value="HIGH_DISCOUNT_RATE">ë†’ì€ í• ì¸ìœ¨ìˆœ</li>
                <li data-value="HIGH_REVIEW">ë¦¬ë·° ë§ì€ìˆœ</li>
                <li data-value="HIGH_VIEW">ì¡°íšŒìˆ˜ ë§ì€ìˆœ</li>
            </ul>
        </div>
    </div>

    <!-- ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ -->
    <div class="product-list">
        <!-- Thymeleaf ì¡°ê±´ë¬¸ìœ¼ë¡œ ìƒí’ˆ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ -->
        <div th:if="${#lists.isEmpty(products)}" class="no-products">
            ìƒí’ˆì´ 0ê°œì…ë‹ˆë‹¤.
        </div>

        <!-- Thymeleaf ë°˜ë³µë¬¸ìœ¼ë¡œ ë™ì  ë Œë”ë§ -->
        <div th:if="${!#lists.isEmpty(products)}" th:each="product, iterStat : ${products}" class="product-card" th:attr="data-product-id=${product.no}">
            <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
            <img th:src="${product.thumbNailImgUrl}" alt="ìƒí’ˆ ì´ë¯¸ì§€" />

            <!-- ìƒí’ˆ ì •ë³´ -->
            <div class="product-info">
                <h3 class="product-name" th:text="${product.name}">ìƒí’ˆ ì´ë¦„</h3>
                <div class="price-discount">
                    <span class="discount-rate" th:if="${product.discRate > 0}" th:text="${product.discRate + '%'}"></span>
                    <span class="price" th:text="${#numbers.formatInteger(product.sellPrice, 3, 'COMMA')}"></span>
                </div>
                <div class="product-badges">
                    <span class="badge" th:if="${product.freeShip == 'Y'}">ë¬´ë£Œë°°ì†¡</span>
                    <span class="badge" th:if="${product.handMadeYn == 'Y'}">í•¸ë“œë©”ì´ë“œ</span>
                </div>
                <div class="extra-info">
                    <!-- ì°œ ìˆ˜ -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
                        <path d="M8 2C4.685-1.127 0 1.324 0 5.3 0 7.999 3.354 11.324 8 14c4.646-2.676 8-6.001 8-8.7 0-3.976-4.685-6.427-8-3.3-3.315-3.127-8-.676-8 3.3 0 2.699 3.354 6.024 8 8.7 4.646-2.676 8-6.001 8-8.7 0-3.976-4.685-6.427-8-3.3z"/>
                    </svg>
                    <span class="wish-cnt" th:text="${product.wishCnt != null ? product.wishCnt : 0}"></span>

                    <!-- ë³„ì  -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16">
                        <path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.523-3.356c-.329-.314.158-.888-.283-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.22l-4.898.696c-.441.062-.612.636-.282.95l3.522 3.356-.83 4.73z"/>
                    </svg>
                    <span class="avg-rating" th:text="${product.avgR != null ? product.avgR : 0}"></span>

                    <!-- ë¦¬ë·° ìˆ˜ -->
                    (<span class="review-cnt" th:text="${product.rvwCnt != null ? product.rvwCnt : 0}"></span>)
                </div>
            </div>
        </div>
    </div>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div th:if="${totalPages > 1}" class="pagination">
        <th:block th:with="
        groupSize=10,
        currentGroup=${(page / groupSize) + 1},
        startPage=${(currentGroup - 1) * groupSize},
        endPage=${startPage + groupSize - 1 > totalPages - 1 ? totalPages - 1 : startPage + groupSize - 1}">

            <!-- ì´ì „ ê·¸ë£¹ ì´ë™ -->
            <a th:if="${startPage > 0}" href="#" class="prev-group" data-page="${startPage - 1}">&laquo;</a>

            <!-- í˜ì´ì§€ ë²ˆí˜¸ í‘œì‹œ (í•œ ë²ˆì— 10ê°œì”©) -->
            <span th:each="i : ${#numbers.sequence(startPage, endPage)}"
                  th:classappend="${page == i} ? 'active' : ''">
            <a href="#" class="page-link" th:attr="data-page=${i}" th:text="${i + 1}"></a>
        </span>

            <!-- ë‹¤ìŒ ê·¸ë£¹ ì´ë™ -->
            <a th:if="${endPage < totalPages - 1}" href="#" class="next-group" data-page="${endPage + 1}">&raquo;</a>
        </th:block>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const select = document.querySelector(".custom-select");
            const selectedOption = select.querySelector(".selected-option");
            const searchInput = document.getElementById("search-input"); // ê²€ìƒ‰ ì…ë ¥ì°½
            const searchButton = document.querySelector(".search-bar button"); // ê²€ìƒ‰ ë²„íŠ¼
            const urlParams = new URLSearchParams(window.location.search);

            // âœ… ê¸°ì¡´ URL ìœ ì§€í•˜ë©´ì„œ ê²€ìƒ‰ íŒŒë¼ë¯¸í„° ìœ ì§€ + í˜ì´ì§€ ì´ˆê¸°í™”
            function updateURLParam(key, value) {
                const urlParams = new URLSearchParams(window.location.search);

                if (value) {
                    urlParams.set(key, value);
                } else {
                    urlParams.delete(key);
                }

                // âœ… ê²€ìƒ‰ ë˜ëŠ” ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ í˜ì´ì§€ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”
                if (key === "keyword" || key === "category") {
                    urlParams.set("page", 0);
                }

                console.log("Updated URL:", urlParams.toString()); // ë””ë²„ê¹…ìš©
                sendAjaxRequest(urlParams);
            }


            // // âœ… ì´ˆê¸° ë¡œë”© ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë¹„ë™ê¸° í˜¸ì¶œ)
            // fetch(`/api/v1/product/catalog/list?${urlParams.toString()}`, {
            //     method: "GET",
            //     headers: { "X-Requested-With": "XMLHttpRequest" }
            // })
            //     .then(response => response.json())
            //     .then(data => {
            //         updateProductList(data.data.products);
            //         updatePagination(data.data.pageInfo);
            //     })
            //     .catch(error => console.error("Error:", error));

            // âœ… ì •ë ¬ ë“œë¡­ë‹¤ìš´ ì—´ê¸°/ë‹«ê¸°
            selectedOption.addEventListener("click", () => {
                select.classList.toggle("open");
            });

            // âœ… ì •ë ¬ ì˜µì…˜ ì„ íƒ ì´ë²¤íŠ¸ (ê¸°ì¡´ URL ìœ ì§€)
            document.querySelectorAll(".dropdown-options li").forEach(option => {
                option.addEventListener("click", function () {
                    const selectedOrder = this.getAttribute("data-value");
                    updateURLParam("order", selectedOrder);
                    updateSelectedOrderText(this.textContent);
                    select.classList.remove("open");
                });
            });

            // âœ… ì •ë ¬ ì„ íƒ UI ì—…ë°ì´íŠ¸
            function updateSelectedOrderText(text) {
                selectedOption.childNodes[0].nodeValue = text + " "; // `dropdown-arrow` ìœ ì§€
            }

            // âœ… ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (í˜ì´ì§€ ì´ˆê¸°í™” ìœ ì§€)
            searchButton.addEventListener("click", function () {
                const keyword = searchInput.value.trim();
                updateURLParam("keyword", keyword);
            });


            // âœ… ê²€ìƒ‰ì°½ Enter í‚¤ ì…ë ¥ ì´ë²¤íŠ¸
            searchInput.addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    searchButton.click();
                }
            });

            // âœ… í—¤ë” ì¹´í…Œê³ ë¦¬ ë©”ë‰´ í´ë¦­ ì´ë²¤íŠ¸ (ê¸°ë³¸ ì´ë™ ìœ ì§€)
            document.querySelectorAll(".nav-list a").forEach(link => {
                link.addEventListener("click", function (event) {
                    const isDropdown = this.closest(".dropdown"); // ë“œë¡­ë‹¤ìš´ ë‚´ë¶€ì¸ì§€ í™•ì¸

                    if (isDropdown) {
                        // ì¤‘ë¶„ë¥˜ ì¹´í…Œê³ ë¦¬ í´ë¦­ ì‹œ ê¸°ë³¸ ì´ë™ (AJAX ìš”ì²­ X)
                        return; // ê¸°ë³¸ ë™ì‘ ìˆ˜í–‰ (í˜ì´ì§€ ì´ë™)
                    }

                    event.preventDefault(); // ê¸°ë³¸ ì´ë™ ë°©ì§€ (ë¹„ë™ê¸° ìš”ì²­ì„ ì‚¬ìš©)
                    urlParams.delete("page"); // í˜ì´ì§€ ë²ˆí˜¸ ì´ˆê¸°í™”
                    window.location.href = this.href; // ì§ì ‘ í˜ì´ì§€ ì´ë™ (ìƒˆë¡œê³ ì¹¨)
                });
            });


            // âœ… í˜ì´ì§€ë„¤ì´ì…˜ í´ë¦­ ì´ë²¤íŠ¸ (ê¸°ì¡´ URL ìœ ì§€)
            document.body.addEventListener("click", function (event) {
                if (event.target.matches(".pagination a")) {
                    event.preventDefault();
                    const newPage = parseInt(event.target.getAttribute("data-page"), 10);
                    updateURLParam("page", newPage);
                }
            });

            // âœ… ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì´ë²¤íŠ¸ (ê¸°ì¡´ í•„í„° ìœ ì§€)
            document.body.addEventListener("click", function (event) {
                if (event.target.matches(".category-link")) {
                    event.preventDefault();
                    const selectedCategory = event.target.getAttribute("data-category");
                    updateURLParam("category", selectedCategory);
                }
            });
        });

        // // âœ… ê³µí†µ AJAX ìš”ì²­ í•¨ìˆ˜
        // function sendAjaxRequest(params) {
        //     const newUrl = `/api/v1/product/catalog/list?${params.toString()}`;
        //
        //     // âœ… ë¸Œë¼ìš°ì €ì˜ ì£¼ì†Œì°½ URL ë³€ê²½ (ë’¤ë¡œ ê°€ê¸° ê°€ëŠ¥)
        //     history.pushState(null, "", newUrl);
        //
        //     fetch(newUrl, {
        //         method: "GET",
        //         headers: { "X-Requested-With": "XMLHttpRequest" }
        //     })
        //         .then(response => response.json())
        //         .then(data => {
        //             updateProductList(data.data.products);
        //             updatePagination(data.data.pageInfo);
        //             updateCategoryActiveState(params.get("category"));
        //             window.scrollTo({ top: 0, behavior: "smooth" });
        //         })
        //         .catch(error => console.error("Error:", error));
        // }
        //
        // // âœ… ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        // function updateProductList(products) {
        //     const productListContainer = document.querySelector(".product-list");
        //     productListContainer.innerHTML = "";
        //
        //     // í˜„ì¬ URLì—ì„œ keyword íŒŒë¼ë¯¸í„° í™•ì¸ (ê²€ìƒ‰ ì—¬ë¶€ íŒë‹¨)
        //     const urlParams = new URLSearchParams(window.location.search);
        //     const keyword = urlParams.get("keyword");
        //
        //     if (products.length === 0) {
        //         if (keyword) {
        //             // ğŸ”¹ ê²€ìƒ‰ì–´ê°€ ìˆì„ ë•Œ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ ë¬¸êµ¬ í‘œì‹œ
        //             productListContainer.innerHTML = '<div class="no-products">í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì—ëŠ” ê²€ìƒ‰ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        //         } else {
        //             // ğŸ”¹ ì¼ë°˜ì ì¸ ê²½ìš° ìƒí’ˆ ì—†ìŒ ë¬¸êµ¬ í‘œì‹œ
        //             productListContainer.innerHTML = '<div class="no-products">ìƒí’ˆì´ 0ê°œì…ë‹ˆë‹¤.</div>';
        //         }
        //         return;
        //     }
        //
        //     products.forEach(product => {
        //         const productCard = `
        // <div class="product-card" data-product-id="${product.no}">
        //     <img src="${product.thumbNailImgUrl}" alt="ìƒí’ˆ ì´ë¯¸ì§€" />
        //     <div class="product-info">
        //         <h3 class="product-name">${product.name}</h3>
        //         <div class="price-discount">
        //             ${product.discRate > 0 ? `<span class="discount-rate">${product.discRate}%</span>` : ""}
        //             <span class="price">${product.sellPrice.toLocaleString()}</span>
        //         </div>
        //         <div class="product-badges">
        //             ${product.freeShip === "Y" ? '<span class="badge">ë¬´ë£Œë°°ì†¡</span>' : ""}
        //             ${product.handMadeYn === "Y" ? '<span class="badge">í•¸ë“œë©”ì´ë“œ</span>' : ""}
        //         </div>
        //         <div class="extra-info">
        //             <!-- ì°œ ìˆ˜ (í•˜íŠ¸ ì•„ì´ì½˜) -->
        //             <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
        //                 <path d="M8 2C4.685-1.127 0 1.324 0 5.3 0 7.999 3.354 11.324 8 14c4.646-2.676 8-6.001 8-8.7 0-3.976-4.685-6.427-8-3.3-3.315-3.127-8-.676-8 3.3 0 2.699 3.354 6.024 8 8.7 4.646-2.676 8-6.001 8-8.7 0-3.976-4.685-6.427-8-3.3z"/>
        //             </svg>
        //             <span class="wish-cnt">${product.wishCnt || 0}</span>
        //
        //             <!-- ë³„ì  ì•„ì´ì½˜ -->
        //             <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16">
        //                 <path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.523-3.356c-.329-.314.158-.888-.283-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.22l-4.898.696c-.441.062-.612.636-.282.95l3.522 3.356-.83 4.73z"/>
        //             </svg>
        //             <span class="avg-rating">${product.avgR || 0}</span>
        //
        //             <!-- ë¦¬ë·° ê°œìˆ˜ -->
        //             (<span class="review-cnt">${product.rvwCnt || 0}</span>)
        //         </div>
        //     </div>
        // </div>`;
        //         productListContainer.innerHTML += productCard;
        //     });
        // }
        //
        // // âœ… í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
        // function updatePagination(pageInfo) {
        //     const paginationContainer = document.querySelector(".pagination");
        //     let paginationHTML = "";
        //
        //     const groupSize = 10;
        //     const currentGroup = Math.floor(pageInfo.currentPage / groupSize) + 1;
        //     const startPage = (currentGroup - 1) * groupSize;
        //     const endPage = Math.min(startPage + groupSize - 1, pageInfo.totalPages - 1);
        //
        //     if (startPage > 0) {
        //         paginationHTML += `<a href="#" class="prev-group" data-page="${startPage - 1}">&laquo;</a>`;
        //     }
        //
        //     for (let i = startPage; i <= endPage; i++) {
        //         paginationHTML += `
        // <span class="${pageInfo.currentPage === i ? 'active' : ''}">
        //     <a href="#" class="page-link" data-page="${i}">${i + 1}</a>
        // </span>`;
        //     }
        //
        //     if (endPage < pageInfo.totalPages - 1) {
        //         paginationHTML += `<a href="#" class="next-group" data-page="${endPage + 1}">&raquo;</a>`;
        //     }
        //
        //     paginationContainer.innerHTML = paginationHTML;
        // }
        //
        // // âœ… ì¹´í…Œê³ ë¦¬ active ìƒíƒœ ì—…ë°ì´íŠ¸
        // function updateCategoryActiveState(selectedCategory) {
        //     document.querySelectorAll(".category-menu li").forEach(li => {
        //         li.classList.remove("active");
        //     });
        //
        //     if (!selectedCategory) {
        //         document.querySelector(".category-menu li:first-child").classList.add("active");
        //     } else {
        //         document.querySelector(`.category-menu a[data-category="${selectedCategory}"]`)
        //             ?.closest("li").classList.add("active");
        //     }
        // }
    </script>
</div>
