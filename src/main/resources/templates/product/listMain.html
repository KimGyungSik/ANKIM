<div class="list-main" th:fragment="listMain">
    <!-- 중분류 카테고리 이름과 검색 -->
    <div class="category-header">
        <h2 class="subcategory-title">중분류 카테고리 이름</h2>
        <div class="search-bar">
            <input type="text" id="search-input" />
            <button type="button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-search">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
        </div>
    </div>
    <!-- 카테고리와 정렬 -->
    <div class="category-sort-section">
        <!-- 카테고리 메뉴 -->
        <div class="category-menu">
            <ul>
                <li><a href="#">전체</a></li>
                <li><a href="#">미니 원피스</a></li>
                <li><a href="#">미디 원피스</a></li>
                <li><a href="#">롱 원피스</a></li>
                <li><a href="#">데님 원피스</a></li>
            </ul>
        </div>
        <!-- 정렬 선택 -->
        <div class="custom-select">
            <div class="selected-option" tabindex="0">
                인기순
                <span class="dropdown-arrow">▼</span>
            </div>
            <ul class="dropdown-options">
                <li data-value="POPULAR">인기순</li>
                <li data-value="LATEST">최신순</li>
                <li data-value="LOW_PRICE">낮은 가격순</li>
                <li data-value="HIGH_PRICE">높은 가격순</li>
                <li data-value="HIGH_DISCOUNT_RATE">높은 할인율순</li>
                <li data-value="HIGH_REVIEW">리뷰 많은순</li>
                <li data-value="HIGH_VIEW">조회수 많은순</li>
            </ul>
        </div>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const select = document.querySelector(".custom-select");
                const selectedOption = select.querySelector(".selected-option");
                const options = select.querySelector(".dropdown-options");

                selectedOption.addEventListener("click", () => {
                    select.classList.toggle("open");
                });

                options.addEventListener("click", (event) => {
                    if (event.target.tagName === "LI") {
                        selectedOption.textContent = event.target.textContent;
                        select.classList.remove("open");
                    }
                });

                document.addEventListener("click", (event) => {
                    if (!select.contains(event.target)) {
                        select.classList.remove("open");
                    }
                });
            });
        </script>
    </div>

    <!-- 상품 리스트 -->
    <div class="product-list">
        <!-- Thymeleaf 조건문으로 상품 존재 여부 확인 -->
        <div th:if="${#lists.isEmpty(products)}" class="no-products">
            상품이 0개입니다.
        </div>

        <!-- Thymeleaf 반복문으로 동적 렌더링 -->
        <div th:if="${!#lists.isEmpty(products)}" th:each="product, iterStat : ${products}" class="product-card" th:attr="data-product-id=${product.no}">
            <!-- 상품 이미지 -->
            <img th:src="${product.thumbNailImgUrl}" alt="상품 이미지" />

            <!-- 상품 정보 -->
            <div class="product-info">
                <h3 class="product-name" th:text="${product.name}">상품 이름</h3>
                <div class="price-discount">
                    <span class="discount-rate" th:if="${product.discRate > 0}" th:text="${product.discRate + '%'}"></span>
                    <span class="price" th:text="${#numbers.formatInteger(product.sellPrice, 3, 'COMMA')}"></span>
                </div>
                <div class="product-badges">
                    <span class="badge" th:if="${product.freeShip == 'Y'}">무료배송</span>
                    <span class="badge" th:if="${product.handMadeYn == 'Y'}">핸드메이드</span>
                </div>
                <div class="extra-info">
                    <!-- 찜 수 -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
                        <path d="M8 2C4.685-1.127 0 1.324 0 5.3 0 7.999 3.354 11.324 8 14c4.646-2.676 8-6.001 8-8.7 0-3.976-4.685-6.427-8-3.3-3.315-3.127-8-.676-8 3.3 0 2.699 3.354 6.024 8 8.7 4.646-2.676 8-6.001 8-8.7 0-3.976-4.685-6.427-8-3.3z"/>
                    </svg>
                    <span class="wish-cnt" th:text="${product.wishCnt != null ? product.wishCnt : 0}"></span>

                    <!-- 별점 -->
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16">
                        <path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.523-3.356c-.329-.314.158-.888-.283-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.22l-4.898.696c-.441.062-.612.636-.282.95l3.522 3.356-.83 4.73z"/>
                    </svg>
                    <span class="avg-rating" th:text="${product.avgR != null ? product.avgR : 0}"></span>

                    <!-- 리뷰 수 -->
                    (<span class="review-cnt" th:text="${product.rvwCnt != null ? product.rvwCnt : 0}"></span>)
                </div>
            </div>
        </div>
    </div>

    <!-- 페이지네이션 -->
    <div th:if="${totalPages > 1}" class="pagination">
        <th:block th:with="
        groupSize=10,
        currentGroup=${(page / groupSize) + 1},
        startPage=${(currentGroup - 1) * groupSize},
        endPage=${startPage + groupSize - 1 > totalPages - 1 ? totalPages - 1 : startPage + groupSize - 1}">

            <!-- 이전 그룹 이동 -->
            <a th:if="${startPage > 0}" href="#" class="prev-group" data-page="${startPage - 1}">&laquo;</a>

            <!-- 페이지 번호 표시 (한 번에 10개씩) -->
            <span th:each="i : ${#numbers.sequence(startPage, endPage)}"
                  th:classappend="${page == i} ? 'active' : ''">
            <a href="#" class="page-link" th:attr="data-page=${i}" th:text="${i + 1}"></a>
        </span>

            <!-- 다음 그룹 이동 -->
            <a th:if="${endPage < totalPages - 1}" href="#" class="next-group" data-page="${endPage + 1}">&raquo;</a>
        </th:block>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 최초 로딩 시 현재 URL의 페이지네이션 정보를 업데이트
            const urlParams = new URLSearchParams(window.location.search);
            const currentPage = parseInt(urlParams.get("page")) || 0;
            fetch(`/api/v1/product/catalog/list?${urlParams.toString()}`, {
                method: "GET",
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
                .then(response => response.json())
                .then(data => {
                    updateProductList(data.data.products);
                    updatePagination(data.data.pageInfo);
                })
                .catch(error => console.error("Error:", error));

            // 페이지네이션 이벤트 위임 방식으로 등록 (모든 동적 요소 대응)
            document.body.addEventListener("click", function (event) {
                if (event.target.matches(".pagination a")) {
                    event.preventDefault(); // 기본 링크 이동 방지

                    const newPage = parseInt(event.target.getAttribute("data-page"), 10);

                    // 현재 URL에서 queryString 유지하면서 page 값만 변경
                    urlParams.set("page", newPage);
                    const newUrl = `/api/v1/product/catalog/list?${urlParams.toString()}`;

                    // AJAX 요청 (비동기 페이지 변경)
                    fetch(newUrl, {
                        method: "GET",
                        headers: { "X-Requested-With": "XMLHttpRequest" }
                    })
                        .then(response => response.json())
                        .then(data => {
                            updateProductList(data.data.products);
                            updatePagination(data.data.pageInfo);
                        })
                        .catch(error => console.error("Error:", error));
                }
            });
        });

        function updateProductList(products) {
            const productListContainer = document.querySelector(".product-list");
            productListContainer.innerHTML = "";

            if (products.length === 0) {
                productListContainer.innerHTML = '<div class="no-products">상품이 0개입니다.</div>';
                return;
            }

            products.forEach(product => {
                const productCard = `
        <div class="product-card" data-product-id="${product.no}">
            <img src="${product.thumbNailImgUrl}" alt="상품 이미지" />
            <div class="product-info">
                <h3 class="product-name">${product.name}</h3>
                <div class="price-discount">
                    ${product.discRate > 0 ? `<span class="discount-rate">${product.discRate}%</span>` : ""}
                    <span class="price">${product.sellPrice.toLocaleString()}</span>
                </div>
                <div class="product-badges">
                    ${product.freeShip === "Y" ? '<span class="badge">무료배송</span>' : ""}
                    ${product.handMadeYn === "Y" ? '<span class="badge">핸드메이드</span>' : ""}
                </div>
                <div class="extra-info">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
                        <path d="M8 2C4.685-1.127 0 1.324 0 5.3 0 7.999 3.354 11.324 8 14c4.646-2.676 8-6.001 8-8.7 0-3.976-4.685-6.427-8-3.3-3.315-3.127-8-.676-8 3.3 0 2.699 3.354 6.024 8 8.7 4.646-2.676 8-6.001 8-8.7 0-3.976-4.685-6.427-8-3.3z"/>
                    </svg>
                    <span class="wish-cnt">${product.wishCnt || 0}</span>

                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-star" viewBox="0 0 16 16">
                        <path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.523-3.356c-.329-.314.158-.888-.283-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.22l-4.898.696c-.441.062-.612.636-.282.95l3.522 3.356-.83 4.73z"/>
                    </svg>
                    <span class="avg-rating">${product.avgR || 0}</span>
                    (<span class="review-cnt">${product.rvwCnt || 0}</span>)
                </div>
            </div>
        </div>
        `;
                productListContainer.innerHTML += productCard;
            });
        }

        function updatePagination(pageInfo) {
            const paginationContainer = document.querySelector(".pagination");
            let paginationHTML = "";

            const groupSize = 10; // 한 번에 표시할 페이지 개수
            const currentGroup = Math.floor(pageInfo.currentPage / groupSize) + 1;
            const startPage = (currentGroup - 1) * groupSize;
            const endPage = Math.min(startPage + groupSize - 1, pageInfo.totalPages - 1);

            // 이전 그룹 이동 버튼
            if (startPage > 0) {
                paginationHTML += `<a href="#" class="prev-group" data-page="${startPage - 1}">&laquo;</a>`;
            }

            // 페이지 번호 표시 (한 번에 10개씩)
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
        <span class="${pageInfo.currentPage === i ? 'active' : ''}">
            <a href="#" class="page-link" data-page="${i}">${i + 1}</a>
        </span>
        `;
            }

            // 다음 그룹 이동 버튼
            if (endPage < pageInfo.totalPages - 1) {
                paginationHTML += `<a href="#" class="next-group" data-page="${endPage + 1}">&raquo;</a>`;
            }

            paginationContainer.innerHTML = paginationHTML;
        }
    </script>
</div>
